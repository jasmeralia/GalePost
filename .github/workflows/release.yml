name: Build & Draft Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Lint
        run: make lint

      - name: Test with coverage
        run: make test-cov

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: Build Windows Executable
    needs: lint-and-test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install NSIS
        run: choco install nsis -y

      - name: Build executable
        run: pyinstaller build/build.spec --distpath dist/ --workpath build/tmp --clean

      - name: Build installer
        shell: pwsh
        run: |
          $nsis = "${env:ProgramFiles(x86)}\\NSIS\\makensis.exe"
          if (-not (Test-Path $nsis)) {
            $nsis = "${env:ProgramFiles}\\NSIS\\makensis.exe"
          }
          & $nsis build\\installer.nsi

      - name: Create portable zip
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          Compress-Archive -Path dist/GaleFling.exe -DestinationPath "dist/GaleFling-${version}-portable.zip"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            build/GaleFling-Setup-*.exe

  release:
    name: Create Draft Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: .
          merge-multiple: true

      - name: Remove portable zip
        run: |
          find . -name "*-portable.zip" -delete

      - name: List release assets
        run: |
          echo "Installer assets found:"
          find . -name "GaleFling-Setup-*.exe" -print

      - name: Generate release notes from commits
        id: release_notes
        run: |
          # Find the previous release tag (including prereleases, excluding current)
          PREV_TAG=$(python - <<'PY'
          import json
          import os
          import urllib.request

          repo = os.environ.get("GITHUB_REPOSITORY")
          current = os.environ.get("CURRENT_TAG", "")
          url = f"https://api.github.com/repos/{repo}/releases?per_page=20"

          tag = ""
          try:
              with urllib.request.urlopen(url, timeout=10) as resp:
                  data = json.load(resp)
              for release in data:
                  if release.get("draft"):
                      continue
                  rel_tag = release.get("tag_name", "")
                  if rel_tag and rel_tag != current:
                      tag = rel_tag
                      break
          except Exception:
              tag = ""

          if not tag:
              tags = os.popen("git tag --sort=-v:refname").read().strip().splitlines()
              for rel_tag in tags:
                  if rel_tag and rel_tag != current:
                      tag = rel_tag
                      break

          print(tag)
          PY
          )
          CURRENT_TAG="${{ github.ref_name }}"

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$CURRENT_TAG" ]; then
            # First tag - use all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" "${PREV_TAG}..${CURRENT_TAG}")
          fi

          # Extract version from tag
          VERSION="${CURRENT_TAG#v}"

          # Extract changelog sections between current tag and last published release
          CHANGELOG_SECTION=""
          if [ -f CHANGELOG.md ]; then
            CHANGELOG_SECTION=$(python scripts/release_notes.py)
          fi

          # Build the body
          {
            echo "body<<RELEASE_EOF"
            if [ -n "$CHANGELOG_SECTION" ]; then
              echo "## What's Changed"
              echo ""
              echo "$CHANGELOG_SECTION"
              echo ""
            fi
            echo "---"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}"
            echo "RELEASE_EOF"
          } >> "$GITHUB_OUTPUT"
        env:
          CURRENT_TAG: ${{ github.ref_name }}

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: true
          name: "${{ github.ref_name }} - GaleFling"
          body: ${{ steps.release_notes.outputs.body }}
          files: |
            **/GaleFling-Setup-*.exe
