name: Build & Draft Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Lint
        run: make lint

      - name: Test
        run: make test

  build:
    name: Build Windows Executable
    needs: lint-and-test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Build executable
        run: pyinstaller build/build.spec --distpath dist/ --workpath build/tmp --clean

      - name: Create portable zip
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          Compress-Archive -Path dist/GalePost.exe -DestinationPath "dist/GalePost-${version}-portable.zip"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/GalePost.exe
            dist/GalePost-*-portable.zip

  release:
    name: Create Draft Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist/

      - name: Generate release notes from commits
        id: release_notes
        run: |
          # Find the previous tag
          PREV_TAG=$(git tag --sort=-v:refname | head -n 2 | tail -n 1)
          CURRENT_TAG="${{ github.ref_name }}"

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$CURRENT_TAG" ]; then
            # First tag - use all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" "${PREV_TAG}..${CURRENT_TAG}")
          fi

          # Extract version from tag
          VERSION="${CURRENT_TAG#v}"

          # Extract changelog section for this version if it exists
          CHANGELOG_SECTION=""
          if [ -f CHANGELOG.md ]; then
            CHANGELOG_SECTION=$(awk "/^## \[${VERSION}\]/{found=1; next} /^## \[/{if(found) exit} found{print}" CHANGELOG.md)
          fi

          # Build the body
          {
            echo "body<<RELEASE_EOF"
            if [ -n "$CHANGELOG_SECTION" ]; then
              echo "## What's Changed"
              echo ""
              echo "$CHANGELOG_SECTION"
              echo ""
            fi
            echo "## Commits"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "---"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}"
            echo "RELEASE_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: "v${{ github.ref_name }} - GalePost"
          body: ${{ steps.release_notes.outputs.body }}
          files: |
            dist/GalePost.exe
            dist/GalePost-*-portable.zip
